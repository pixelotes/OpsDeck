{% extends "layout.html" %}

{% set title = "Edit Asset" if asset else "New Asset" %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block content %}
<h2><i class="fas fa-laptop"></i> {{ title }}</h2>
<hr>

{% if asset and asset.purchase and asset.purchase.validated_cost is not none %}
<div class="alert alert-warning" role="alert">
    <i class="fas fa-lock"></i> The associated purchase for this asset has a validated cost. Price, currency, purchase date, and other financial details cannot be changed.
</div>
{% endif %}

<div class="card">
    <div class="card-body">
        <form method="POST">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Name *</label>
                    <input type="text" class="form-control" id="name" name="name" value="{{ asset.name if asset else '' }}" required>
                </div>
                <div class="col-md-6">
                    <label for="status" class="form-label">Status *</label>
                    <select class="form-select" id="status" name="status" required>
                        {% set statuses = ['In Use', 'Stored', 'In Repair', 'Awaiting Disposal', 'Disposed', 'Sold'] %}
                        {% for status in statuses %}
                            {% if status in ['Disposed', 'Sold'] and asset and asset.status != status %}
                                <option value="{{ status }}" disabled>{{ status }} (use "Record Disposal" action)</option>
                            {% else %}
                                <option value="{{ status }}" {% if asset and asset.status == status %}selected{% endif %}>{{ status }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="brand" class="form-label">Brand</label>
                    <input type="text" class="form-control" id="brand" name="brand" value="{{ asset.brand if asset else '' }}">
                </div>
                <div class="col-md-4">
                    <label for="model" class="form-label">Model</label>
                    <input type="text" class="form-control" id="model" name="model" value="{{ asset.model if asset else '' }}">
                </div>
                <div class="col-md-4">
                    <label for="serial_number" class="form-label">Serial Number</label>
                    <input type="text" class="form-control" id="serial_number" name="serial_number" value="{{ asset.serial_number if asset else '' }}">
                </div>
            </div>
            
            <hr>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="purchase_date" class="form-label">Purchase Date</label>
                    <input type="date" class="form-control" id="purchase_date" name="purchase_date" value="{{ asset.purchase_date.strftime('%Y-%m-%d') if asset and asset.purchase_date else '' }}" {% if asset and asset.purchase and asset.purchase.validated_cost is not none %}disabled{% endif %}>
                </div>
                <div class="col-md-4">
                    <label for="cost" class="form-label">Cost</label>
                    <input type="number" step="0.01" class="form-control" id="cost" name="cost" value="{{ asset.cost if asset else '' }}" {% if asset and asset.purchase and asset.purchase.validated_cost is not none %}disabled{% endif %}>
                </div>
                <div class="col-md-4">
                    <label for="currency" class="form-label">Currency</label>
                    <select class="form-select" id="currency" name="currency" {% if asset and asset.purchase and asset.purchase.validated_cost is not none %}disabled{% endif %}>
                        {% set currencies = ['EUR', 'USD', 'GBP', 'ZAR'] %}
                        {% for curr in currencies %}
                        <option value="{{ curr }}" {% if asset and asset.currency == curr %}selected{% endif %}>{{ curr }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                 <div class="col-md-6">
                    <label for="warranty_length" class="form-label">Warranty Length (months)</label>
                    <input type="number" class="form-control" id="warranty_length" name="warranty_length" min="0" value="{{ asset.warranty_length if asset and asset.warranty_length is not none else '' }}">
                </div>
            </div>
            
            <hr>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="user_id" class="form-label">Assigned To User</label>
                    <select class="form-select" id="user_id" name="user_id">
                        <option value="">Select a user...</option>
                        {% for user in users %}
                        <option value="{{ user.id }}" {% if asset and asset.user_id == user.id %}selected{% endif %}>
                            {{ user.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="location_id" class="form-label">Location</label>
                    <select class="form-select" id="location_id" name="location_id">
                        <option value="">Select a location...</option>
                        {% for location in locations %}
                        <option value="{{ location.id }}" {% if asset and asset.location_id == location.id %}selected{% endif %}>
                            {{ location.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="supplier_id" class="form-label">Supplier</label>
                    <select class="form-select" id="supplier_id" name="supplier_id">
                        <option value="">Select a supplier...</option>
                        {% for supplier in suppliers %}
                        <option value="{{ supplier.id }}" {% if asset and asset.supplier_id == supplier.id %}selected{% endif %}>
                            {{ supplier.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                 <div class="col-md-6">
                    <label for="purchase_id" class="form-label">Associated Purchase</label>
                    <select class="form-select" id="purchase_id" name="purchase_id">
                        <option value="">Select a purchase...</option>
                        {% for purchase in purchases %}
                        <option value="{{ purchase.id }}" {% if asset and asset.purchase_id == purchase.id %}selected{% endif %}>
                            {{ purchase.description }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="comments" class="form-label">Comments</label>
                <textarea class="form-control" id="comments" name="comments" rows="4">{{ asset.comments if asset else '' }}</textarea>
            </div>
            
            <div class="mt-4">
                <a href="{{ url_for('assets.assets') }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Save Asset</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}